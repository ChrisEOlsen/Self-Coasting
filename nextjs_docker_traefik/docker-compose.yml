services:
  nextjs-site:
    build: .
    container_name: my-nextjs-site # You can change this
    restart: unless-stopped
    networks:
      - proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"

      # Redirect HTTP → HTTPS
      - "traefik.http.routers.myapp.entrypoints=web"
      - "traefik.http.routers.myapp.rule=Host(`myapp.mydomain.com`)" 
      - "traefik.http.routers.myapp.middlewares=redirect-to-https"

      # HTTPS Router – secure headers only
      - "traefik.http.routers.myapp-secure.entrypoints=websecure"
      - "traefik.http.routers.myapp-secure.rule=Host(`myapp.mydomain.com`)" 
      - "traefik.http.routers.myapp-secure.tls=true"
      - "traefik.http.routers.myapp-secure.tls.certresolver=cloudflare" 
      - "traefik.http.routers.myapp-secure.middlewares=secure-headers"
      - "traefik.http.routers.myapp-secure.service=myapp-service"

      # Internal service port for Next.js
      - "traefik.http.services.myapp-service.loadbalancer.server.port=3000"

networks:
  proxy:
    external: true